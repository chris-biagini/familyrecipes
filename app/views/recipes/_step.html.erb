<%# locals: (step:, embedded: false, heading_level: 2, scale_factor: 1.0) %>
<%# Three rendering branches: normal step (ingredients + instructions), resolved
    cross-reference (embedded card or link depending on nesting depth), and broken
    reference (target recipe deleted or not yet created). The embedded: flag prevents
    recursive embedding â€” nested cross-references render as links. %>
<section>
  <%- if step.cross_reference_step? -%>
  <%- xref = step.cross_reference_block -%>
  <%- if step.title -%>
  <%= content_tag("h#{heading_level}", step.title) %>
  <%- end -%>
  <%- if xref.resolved? -%>
    <%- if embedded -%>
    <p><%= link_to xref.target_title, recipe_path(xref.target_slug) %></p>
    <%- else -%>
    <%= render 'recipes/embedded_recipe', cross_reference: xref %>
    <%- end -%>
  <%- else -%>
    <%= render 'recipes/broken_reference', cross_reference: xref %>
  <%- end -%>
  <%- else -%>
  <%- if step.title -%>
  <%= content_tag("h#{heading_level}", step.title) %>
  <%- end -%>
  <div>
    <%- unless step.ingredients.empty? -%>
    <div class="ingredients">
      <ul>
        <%- step.ingredients.each do |item| -%>
        <% display = scaled_quantity_display(item, scale_factor) %>
        <li <%= ingredient_data_attrs(item, scale_factor: scale_factor) %>>
          <b class="ingredient-name"><%= item.name %></b><% if display %>, <span class="quantity"><%= display %></span><% end %>
        <%- if item.prep_note -%>
          <small><%= item.prep_note %></small>
        <%- end -%>
        </li>
        <%- end -%>
      </ul>
    </div>
    <%- end -%>

    <%- if step.processed_instructions.present? -%>
    <div class="instructions">
      <%= step.processed_instructions.html_safe %>
    </div>
    <%- elsif step.instructions.present? -%>
    <div class="instructions">
      <%= scalable_instructions(step.instructions) %>
    </div>
    <%- end -%>
  </div>
  <%- end -%>
</section>
