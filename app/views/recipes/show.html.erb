<%# This is a self-contained HTML document â€” no Rails layout needed %>
<!DOCTYPE html>
<%- markdown = Redcarpet::Markdown.new(Redcarpet::Render::HTML, autolink: true, no_intra_emphasis: true) -%>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="rgb(205, 71, 84)">
  <title><%= @recipe.title %></title>
  <link rel="stylesheet" href="/style.css">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
</head>
<body data-recipe-id="<%= @recipe.id %>" data-version-hash="<%= @recipe.version_hash %>">
  <nav>
    <a href="/">Home</a>
    <a href="/index/">Index</a>
    <a href="/groceries/">Groceries</a>
  </nav>

  <main>
    <article class="recipe">
      <header>
        <h1><%= @recipe.title %></h1>
        <%- if @recipe.description -%>
        <p><%= @recipe.description %></p>
        <%- end -%>
        <p class="recipe-meta"><%= @recipe.category %></p>
      </header>

      <%- @recipe.steps.each do |step| -%>
      <section>
        <h2><%= step.tldr %></h2>
        <div>
          <%- unless step.ingredient_list_items.empty? -%>
          <div class="ingredients">
            <ul>
              <%- step.ingredient_list_items.each do |item| -%>
              <%- if item.is_a?(CrossReference) -%>
              <li class="cross-reference">
                <b><a href="/<%= item.target_slug %>"><%= item.target_title %></a></b><% if item.multiplier != 1.0 %>, <span class="quantity"><%= item.multiplier == item.multiplier.to_i ? item.multiplier.to_i : item.multiplier %></span><% end %>
                <%- if item.prep_note -%>
                <small><%= item.prep_note %></small>
                <%- end -%>
              </li>
              <%- else -%>
              <li>
                <b><%= item.name %></b><% if item.quantity %>, <span class="quantity"><%= item.quantity %></span><% end %>
                <%- if item.prep_note -%>
                <small><%= item.prep_note %></small>
                <%- end -%>
              </li>
              <%- end -%>
              <%- end -%>
            </ul>
          </div>
          <%- end -%>

          <%- unless step.instructions.empty? -%>
          <div class="instructions">
            <%# SECURITY: Recipe content is trusted local .md files, not user input.
                When web-based editing is added, switch to Redcarpet::Render::Safe. %>
            <%= markdown.render(step.instructions).html_safe %>
          </div>
          <%- end -%>
        </div>
      </section>
      <%- end -%>

      <%- if @recipe.footer -%>
      <footer>
        <%# SECURITY: Recipe content is trusted local .md files, not user input.
            When web-based editing is added, switch to Redcarpet::Render::Safe. %>
        <%= markdown.render(@recipe.footer).html_safe %>
      </footer>
      <%- end -%>
    </article>
  </main>
  <script src="/recipe-state-manager.js" defer></script>
</body>
</html>
