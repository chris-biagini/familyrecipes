<%# locals: (ingredient_name:, entry:, available_aisles:, next_name: nil, recipes: []) %>
<% has_density = entry&.density_grams.present? %>
<turbo-frame id="nutrition-editor-form">
  <div class="editor-form" data-nutrition-editor-target="formContent">

    <fieldset class="editor-section">
      <legend class="editor-section-title">Nutrition Information</legend>

      <div class="form-row serving-row">
        <label for="editor-basis-grams">Per</label>
        <input type="number" id="editor-basis-grams" class="field-narrow"
               value="<%= format_nutrient_value(entry.basis_grams) if entry&.basis_grams %>"
               inputmode="decimal" step="any" min="0.1"
               placeholder="100"
               data-nutrition-editor-target="basisGrams">
        <span class="field-unit">g</span>
      </div>

      <% IngredientCatalog::NUTRIENT_DISPLAY.each do |label, key, unit| %>
        <% indent = label.size - label.lstrip.size %>
        <div class="nutrient-row indent-<%= indent / 2 %>">
          <label for="editor-<%= key %>"><%= label.strip %></label>
          <input type="number" id="editor-<%= key %>" class="field-narrow"
                 value="<%= format_nutrient_value(entry.public_send(key)) if entry&.public_send(key) %>"
                 inputmode="decimal" step="any" min="0" max="10000"
                 data-nutrition-editor-target="nutrientField"
                 data-nutrient-key="<%= key %>">
          <span class="field-unit"><%= unit %></span>
        </div>
      <% end %>
    </fieldset>

    <fieldset class="editor-section">
      <legend class="editor-section-title">Density</legend>
      <p class="editor-help">
        How much does a measured volume weigh? This lets the app convert
        cups and tablespoons to grams for nutrition math.
      </p>
      <div class="form-row density-row">
        <input type="number" class="field-narrow"
               value="<%= format_nutrient_value(entry.density_volume) if has_density %>"
               inputmode="decimal" step="any" min="0"
               placeholder="1"
               data-nutrition-editor-target="densityVolume"
               aria-label="Volume amount">
        <select class="field-unit-select"
                data-nutrition-editor-target="densityUnit"
                aria-label="Volume unit">
          <option value="">unit</option>
          <% %w[cup tbsp tsp ml l].each do |u| %>
            <option value="<%= u %>" <%= 'selected' if has_density && entry.density_unit == u %>><%= u %></option>
          <% end %>
        </select>
        <span class="portion-eq">=</span>
        <input type="number" class="field-narrow"
               value="<%= format_nutrient_value(entry.density_grams) if has_density %>"
               inputmode="decimal" step="any" min="0"
               placeholder="120"
               data-nutrition-editor-target="densityGrams"
               aria-label="Weight in grams">
        <span class="field-unit">g</span>
      </div>
    </fieldset>

    <fieldset class="editor-section">
      <legend class="editor-section-title">Portions</legend>
      <p class="editor-help">
        Named portions map non-volume units to gram weights. Use "each" for
        items counted by number (eggs, rolls).
      </p>
      <div data-nutrition-editor-target="portionList">
        <% if entry&.portions.present? %>
          <% entry.portions.each do |name, grams| %>
            <%= render 'ingredients/portion_row', name: name, grams: grams %>
          <% end %>
        <% end %>
      </div>
      <button type="button" class="btn add-portion"
              data-action="click->nutrition-editor#addPortion">+ Add portion</button>
    </fieldset>

    <fieldset class="editor-section aisle-section">
      <legend class="editor-section-title">Grocery Aisle</legend>
      <div class="form-row aisle-row">
        <select class="aisle-form-select"
                data-nutrition-editor-target="aisleSelect"
                data-action="change->nutrition-editor#aisleChanged"
                aria-label="Grocery aisle">
          <option value="">(none)</option>
          <%- available_aisles.each do |aisle| -%>
            <option value="<%= aisle %>" <%= 'selected' if entry&.aisle == aisle %>><%= aisle %></option>
          <%- end -%>
          <option disabled>&#x2500;&#x2500;&#x2500;</option>
          <option value="omit" <%= 'selected' if entry&.aisle == 'omit' %>>Omit from Grocery List</option>
          <option disabled>&#x2500;&#x2500;&#x2500;</option>
          <option value="__other__">New aisle&hellip;</option>
        </select>
        <input type="text" class="aisle-new-input" placeholder="New aisle name" hidden
               data-nutrition-editor-target="aisleInput"
               data-action="keydown->nutrition-editor#aisleInputKeydown">
      </div>
    </fieldset>

    <% if recipes.any? %>
      <div class="editor-recipes">
        <span class="editor-recipes-label">Used in</span>
        <% recipes.each_with_index do |recipe, i| %>
          <% unless i.zero? %>, <% end %>
          <%= link_to recipe.title, recipe_path(recipe.slug), target: "_blank" %>
        <% end %>
      </div>
    <% end %>

    <% if next_name %>
      <input type="hidden" data-nutrition-editor-target="nextName" value="<%= next_name %>">
    <% end %>
  </div>
</turbo-frame>
