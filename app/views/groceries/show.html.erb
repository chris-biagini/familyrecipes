<% content_for(:title) { 'Biagini Family Recipes: Groceries' } %>

<% content_for(:head) do %>
  <%= stylesheet_link_tag 'groceries' %>
<% end %>

<% content_for(:scripts) do %>
  <script>
    window.UNIT_PLURALS = <%= @unit_plurals.to_json.html_safe %>;
  </script>
  <%= javascript_include_tag 'notify', defer: true %>
  <%= javascript_include_tag 'wake-lock', defer: true %>
  <%= javascript_include_tag 'qrcodegen', defer: true %>
  <%= javascript_include_tag 'groceries', defer: true %>
  <%= javascript_include_tag 'recipe-editor', defer: true %>
<% end %>

<% content_for(:extra_nav) do %>
  <div>
    <button type="button" id="edit-quick-bites-button" class="btn">Edit Quick Bites</button>
    <button type="button" id="edit-aisles-button" class="btn">Edit Aisles</button>
  </div>
<% end %>

<header id="groceries-header">
  <h1>Groceries</h1>
</header>

<noscript>
  <p><em>This page requires JavaScript to build your shopping list.</em></p>
</noscript>

<p id="instructions" class="hidden-until-js">Select recipes to build your shopping list.</p>

<div id="recipe-selector" class="hidden-until-js">
  <%- @categories.each do |category| -%>
  <%- next if category.recipes.empty? -%>
  <div class="category">
    <h2><%= category.name %></h2>
    <ul>
    <%- category.recipes.sort_by(&:title).each do |recipe| -%>
      <%- parsed = @recipe_map[recipe.slug] -%>
      <%- next unless parsed -%>
      <%- filtered_ingredients = parsed.all_ingredients_with_quantities(@alias_map, @recipe_map).reject { |name, _| @omit_set.include?(name.downcase) } -%>
      <li>
        <input type="checkbox" id="<%= recipe.slug %>-checkbox" data-title="<%= h recipe.title %>" data-ingredients="<%= h filtered_ingredients.to_json %>">
        <label for="<%= recipe.slug %>-checkbox" title="Ingredients: <%= h filtered_ingredients.map(&:first).join(', ') %>"><%= recipe.title %></label>
        <%= link_to raw('&rarr;'), recipe_path(recipe.slug), class: 'recipe-link', title: "Open #{recipe.title} in new tab", target: '_blank' %>
      </li>
    <%- end -%>
    </ul>
  </div>
  <%- end -%>
  <%- if @quick_bites_by_subsection.any? -%>
  <div class="quick-bites">
    <h2>Quick Bites</h2>
    <div class="subsections">
      <%- @quick_bites_by_subsection.each do |subsection, items| -%>
      <div class="subsection">
        <h3><%= subsection %></h3>
        <ul>
        <%- items.each do |item| -%>
          <%- filtered_ingredients = item.ingredients_with_quantities.reject { |name, _| @omit_set.include?(name.downcase) } -%>
          <li>
            <input type="checkbox" id="<%= item.id %>-checkbox" data-title="<%= h item.title %>" data-ingredients="<%= h filtered_ingredients.to_json %>">
            <label for="<%= item.id %>-checkbox" title="Ingredients: <%= h filtered_ingredients.map(&:first).join(', ') %>"><%= item.title %></label>
          </li>
        <%- end -%>
        </ul>
      </div>
      <%- end -%>
    </div>
  </div>
  <%- end -%>
</div>

<div id="custom-items-section" class="hidden-until-js">
  <h2>Additional Items</h2>
  <div id="custom-input-row">
    <label for="custom-input" class="sr-only">Add a custom item</label>
    <input type="text" id="custom-input" placeholder="Add an item...">
    <button id="custom-add" type="button" aria-label="Add item"><svg viewBox="0 0 24 24" width="18" height="18"><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
  </div>
  <ul id="custom-items-list"></ul>
</div>

<div id="share-section" class="hidden-until-js">
  <h2>Share</h2>
  <p id="share-hint">Scan the QR code or copy the link below to open this list on another device.</p>
  <div id="qr-container"></div>
  <div id="share-url-row">
    <code id="share-url"></code>
    <button id="share-action" type="button" aria-label="Share or copy link"></button>
  </div>
  <p id="share-feedback" hidden></p>
</div>

<div id="grocery-preview" class="hidden-until-js">
  <div id="grocery-preview-header">
    <h2>Shopping List</h2>
    <span class="item-count" id="item-count"></span>
  </div>
  <p id="grocery-preview-empty">Select recipes above to build your shopping list.</p>

  <section id="grocery-list">
  <%- @grocery_aisles.each do |aisle, ingredients| -%>
  <%- next if aisle.downcase.tr('_', ' ') == 'omit from list' -%>
  <details class="aisle">
    <summary><%= aisle %> <span class="aisle-count"></span></summary>
    <ul>
      <%- ingredients.each do |ingredient| -%>
        <li data-item="<%= h ingredient[:name] %>" hidden>
          <label class="check-off">
            <input type="checkbox">
            <span><%= ingredient[:name] %><span class="qty"></span></span>
          </label>
        </li>
      <%- end -%>
    </ul>
  </details>
  <%- end -%>

  <details class="aisle" id="misc-aisle">
    <summary>Miscellaneous <span class="aisle-count"></span></summary>
    <ul id="misc-items"></ul>
  </details>
  </section>
</div>

<dialog class="editor-dialog"
        data-editor-open="#edit-quick-bites-button"
        data-editor-url="<%= groceries_quick_bites_path %>"
        data-editor-method="PATCH"
        data-editor-on-success="reload"
        data-editor-body-key="content">
  <div class="editor-header">
    <h2>Edit Quick Bites</h2>
    <button type="button" class="btn editor-close" aria-label="Close">&times;</button>
  </div>
  <div class="editor-errors" hidden></div>
  <textarea class="editor-textarea" spellcheck="false"><%= @quick_bites_content %></textarea>
  <div class="editor-footer">
    <button type="button" class="btn editor-cancel">Cancel</button>
    <button type="button" class="btn btn-primary editor-save">Save</button>
  </div>
</dialog>

<dialog class="editor-dialog"
        data-editor-open="#edit-aisles-button"
        data-editor-url="<%= groceries_grocery_aisles_path %>"
        data-editor-method="PATCH"
        data-editor-on-success="reload"
        data-editor-body-key="content">
  <div class="editor-header">
    <h2>Edit Aisles</h2>
    <button type="button" class="btn editor-close" aria-label="Close">&times;</button>
  </div>
  <div class="editor-errors" hidden></div>
  <textarea class="editor-textarea" spellcheck="false"><%= @grocery_aisles_content %></textarea>
  <div class="editor-footer">
    <button type="button" class="btn editor-cancel">Cancel</button>
    <button type="button" class="btn btn-primary editor-save">Save</button>
  </div>
</dialog>
