<%= render.call('head', title: title, base_path: './') %>

<%- extra_nav = <<HTML
    <div>
      <button type="button" id="scale-button" class="btn">Scale</button>
    </div>
HTML
-%>

<body data-recipe-id="<%= id %>" data-version-hash="<%= version_hash %>">
<%= render.call('nav', extra_nav: extra_nav) %>

  <main>
    <article class="recipe">
      <header>
        <h1><%= title %></h1>
        <%- if description -%>
        <p><%= description %></p>
        <%- end -%>
        <%- if yield_line -%>
        <p class="yield-line"><%= ScalableNumberPreprocessor.process_yield_line(yield_line) %></p>
        <%- end -%>
      </header>

      <%- steps.each do |step| -%>
      <section>
        <h2><%= step.tldr %></h2>
        <div>
          <%- unless step.ingredient_list_items.empty? -%>
          <div class="ingredients">
            <ul>
              <%- step.ingredient_list_items.each do |item| -%>
              <%- if item.is_a?(CrossReference) -%>
              <li class="cross-reference"><b><a href="<%= item.target_slug %>"><%= item.target_title %></a></b><% if item.multiplier != 1.0 %>, <span class="quantity"><%= item.multiplier == item.multiplier.to_i ? item.multiplier.to_i : item.multiplier %></span><% end %>
              <%- if item.prep_note -%>
                <small><%= item.prep_note %></small>
              <%- end -%>
              </li>
              <%- else -%>
              <li<% if item.quantity_value %> data-quantity-value="<%= item.quantity_value %>" data-quantity-unit="<%= item.quantity_unit %>"<% end %>>
                <b><%= item.name %></b><% if item.quantity %>, <span class="quantity"><%= item.quantity%></span><% end %>
              <%- if item.prep_note -%>
                <small><%= item.prep_note %></small>
              <%- end -%>
              </li>
              <%- end -%>
              <%- end -%>
            </ul>
          </div>
          <%- end -%>

          <%- unless step.instructions.empty? -%>
          <div class="instructions">
            <%= markdown.render(ScalableNumberPreprocessor.process_instructions(step.instructions)).strip.gsub(/\n\n+/, "\n").gsub("\n", "\n            ") %>
          </div>
          <%- end -%>
        </div>
      </section>
      <%- end -%>

      <footer>
        <%- if footer -%>
        <%= markdown.render(footer) %>
        <%- end -%>
      </footer>

      <%- if nutrition && nutrition.totals.values.any? { |v| v > 0 } -%>
      <aside class="nutrition-facts">
        <h2>Nutrition Facts</h2>
        <%- has_serving = nutrition.per_serving -%>
        <table>
          <thead>
            <tr>
              <th></th>
              <%- if has_serving -%>
              <th>Per Serving (1/<%= nutrition.serving_count %>)</th>
              <%- end -%>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <%- [
              ['Calories', :calories, 'kcal'],
              ['Protein', :protein, 'g'],
              ['Fat', :fat, 'g'],
              ['Carbs', :carbs, 'g'],
              ['Fiber', :fiber, 'g'],
              ['Sodium', :sodium, 'mg']
            ].each do |label, key, unit| -%>
            <tr>
              <td><%= label %></td>
              <%- if has_serving -%>
              <td><%= nutrition.per_serving[key].round %><%= unit unless key == :calories %></td>
              <%- end -%>
              <td data-nutrient="<%= key %>" data-base-value="<%= nutrition.totals[key].round(1) %>"><%= nutrition.totals[key].round %><%= unit unless key == :calories %></td>
            </tr>
            <%- end -%>
          </tbody>
        </table>
        <%- unless nutrition.complete? -%>
        <p class="nutrition-note">*Approximate. Data unavailable for: <%= (nutrition.missing_ingredients + nutrition.partial_ingredients).uniq.join(', ') %>.</p>
        <%- end -%>
      </aside>
      <%- end -%>
    </article>
  </main>
  <script src="notify.js" defer></script>
  <script src="wake-lock.js" defer></script>
  <script src="recipe-state-manager.js" defer></script>
</body>
</html>
