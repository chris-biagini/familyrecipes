<%= render.call('head', title: title, base_path: './') %>

<%- extra_nav = <<HTML
    <div>
      <button type="button" id="scale-button" class="btn">Scale</button>
    </div>
HTML
-%>

<body data-recipe-id="<%= id %>" data-version-hash="<%= version_hash %>">
<%= render.call('nav', extra_nav: extra_nav) %>

  <main>
    <article class="recipe">
      <header>
        <h1><%= title %></h1>
        <%- if description -%>
        <p><%= description %></p>
        <%- end -%>
        <p class="recipe-meta">
          <a href="index.html#<%= slugify.call(category) %>"><%= category %></a><%- if makes -%>
          <%- if nutrition&.makes_unit_singular -%>
          · Makes <%= ScalableNumberPreprocessor.process_yield_with_unit(makes, nutrition.makes_unit_singular, nutrition.makes_unit_plural) %><%- else -%>
          · Makes <%= ScalableNumberPreprocessor.process_yield_line(makes) %><%- end -%><%- end -%><%- if serves -%>
          · Serves <%= ScalableNumberPreprocessor.process_yield_line(serves) %><%- end -%>
        </p>
      </header>

      <%- steps.each do |step| -%>
      <section>
        <h2><%= step.tldr %></h2>
        <div>
          <%- unless step.ingredient_list_items.empty? -%>
          <div class="ingredients">
            <ul>
              <%- step.ingredient_list_items.each do |item| -%>
              <%- if item.is_a?(CrossReference) -%>
              <li class="cross-reference"><b><a href="<%= item.target_slug %>"><%= item.target_title %></a></b><% if item.multiplier != 1.0 %>, <span class="quantity"><%= item.multiplier == item.multiplier.to_i ? item.multiplier.to_i : item.multiplier %></span><% end %>
              <%- if item.prep_note -%>
                <small><%= item.prep_note %></small>
              <%- end -%>
              </li>
              <%- else -%>
              <li<% if item.quantity_value %> data-quantity-value="<%= item.quantity_value %>" data-quantity-unit="<%= item.quantity_unit_display %>"<%= %( data-quantity-unit-plural="#{inflector.unit_display(item.quantity_unit_display, 2)}") if item.quantity_unit %><% end %>>
                <b><%= item.name %></b><% if item.quantity %>, <span class="quantity"><%= item.quantity%></span><% end %>
              <%- if item.prep_note -%>
                <small><%= item.prep_note %></small>
              <%- end -%>
              </li>
              <%- end -%>
              <%- end -%>
            </ul>
          </div>
          <%- end -%>

          <%- unless step.instructions.empty? -%>
          <div class="instructions">
            <%= markdown.render(ScalableNumberPreprocessor.process_instructions(step.instructions)).strip.gsub(/\n\n+/, "\n").gsub("\n", "\n            ") %>
          </div>
          <%- end -%>
        </div>
      </section>
      <%- end -%>

      <footer>
        <%- if footer -%>
        <%= markdown.render(footer) %>
        <%- end -%>
      </footer>

      <%- if nutrition && nutrition.totals.values.any? { |v| v > 0 } -%>
      <aside class="nutrition-facts">
        <h2>Nutrition Facts</h2>
        <%- # Column logic
            has_per_unit = nutrition.per_unit && nutrition.makes_quantity && nutrition.makes_quantity > 0
            unit_qty_is_one = has_per_unit && nutrition.makes_quantity == 1
            has_per_serving = nutrition.per_serving && nutrition.serving_count

            # Build column list: [label, values_hash, is_scalable_total]
            columns = []

            if has_per_unit && !unit_qty_is_one
              # Per Serving column (if serves exists)
              if has_per_serving && nutrition.units_per_serving
                ups = nutrition.units_per_serving
                formatted_ups = FamilyRecipes::VulgarFractions.format(ups)
                singular = FamilyRecipes::VulgarFractions.singular_noun?(ups)
                ups_unit = singular ? nutrition.makes_unit_singular : nutrition.makes_unit_plural
                columns << ["Per Serving (#{formatted_ups} #{ups_unit})", nutrition.per_serving, false]
              end
              # Per Unit column
              columns << ["Per #{nutrition.makes_unit_singular.capitalize}", nutrition.per_unit, false]
              # Total column
              columns << ['Total', nutrition.totals, true]
            elsif unit_qty_is_one
              # Per Serving column (if serves exists)
              if has_per_serving && nutrition.units_per_serving
                ups = nutrition.units_per_serving
                formatted_ups = FamilyRecipes::VulgarFractions.format(ups)
                singular = FamilyRecipes::VulgarFractions.singular_noun?(ups)
                ups_unit = singular ? nutrition.makes_unit_singular : nutrition.makes_unit_plural
                columns << ["Per Serving (#{formatted_ups} #{ups_unit})", nutrition.per_serving, false]
              end
              # Relabel Total as Per Unit — NOT scalable (it's a fixed reference)
              columns << ["Per #{nutrition.makes_unit_singular.capitalize}", nutrition.totals, false]
            elsif has_per_serving
              # Serves only, no Makes
              columns << ['Per Serving', nutrition.per_serving, false]
              columns << ['Total', nutrition.totals, true]
            else
              # Neither
              columns << ['Total', nutrition.totals, true]
            end
        -%>
        <table>
          <thead>
            <tr>
              <th></th>
              <%- columns.each do |label, _, _| -%>
              <th><%= label %></th>
              <%- end -%>
            </tr>
          </thead>
          <tbody>
            <%- [
              ['Calories', :calories, '', 0],
              ['Total Fat', :fat, 'g', 0],
              ['Sat. Fat', :saturated_fat, 'g', 1],
              ['Trans Fat', :trans_fat, 'g', 1],
              ['Cholesterol', :cholesterol, 'mg', 0],
              ['Sodium', :sodium, 'mg', 0],
              ['Total Carbs', :carbs, 'g', 0],
              ['Fiber', :fiber, 'g', 1],
              ['Total Sugars', :total_sugars, 'g', 1],
              ['Added Sugars', :added_sugars, 'g', 2],
              ['Protein', :protein, 'g', 0],
            ].each do |label, key, unit, indent| -%>
            <tr<%= %( class="indent-#{indent}") if indent > 0 %>>
              <td><%= label %></td>
              <%- columns.each do |_, values, is_scalable| -%>
              <td<%= %( data-nutrient="#{key}" data-base-value="#{values[key].round(1)}") if is_scalable %>><%= values[key].round %><%= unit %></td>
              <%- end -%>
            </tr>
            <%- end -%>
          </tbody>
        </table>
        <%- unless nutrition.complete? -%>
        <p class="nutrition-note">*Approximate. Data unavailable for: <%= (nutrition.missing_ingredients + nutrition.partial_ingredients).uniq.join(', ') %>.</p>
        <%- end -%>
      </aside>
      <%- end -%>
    </article>
  </main>
  <script src="notify.js" defer></script>
  <script src="wake-lock.js" defer></script>
  <script src="recipe-state-manager.js" defer></script>
</body>
</html>
