<%# Helper for HTML escaping -%>
<%- h = ->(text) { ERB::Util.html_escape(text) } -%>

<%# Page-specific styles -%>
<%- extra_styles = '  <link rel="stylesheet" href="groceries.css">' -%>

<%= render.call('head', title: 'Biagini Family Recipes: Groceries', extra_head: extra_styles, base_path: '../') %>

<body>
<%= render.call('nav') %>

  <main>
    <header id="groceries-header">
      <h1>Groceries</h1>
    </header>

    <noscript>
      <p><em>This page requires JavaScript to build your shopping list.</em></p>
    </noscript>

    <p id="instructions" class="hidden-until-js">Select recipes to build your shopping list.</p>

    <div id="recipe-selector" class="hidden-until-js">
      <%- regular_recipes.each do |category, recipes| -%>
      <div class="category">
        <h2><%= category %></h2>
        <ul>
        <%- recipes.each do |recipe| -%>
          <li>
            <input type="checkbox" id="<%= recipe.id %>-checkbox" data-title="<%= h.call(recipe.title) %>" data-ingredients="<%= h.call(recipe.ingredients_with_quantities(alias_map).to_json) %>">
            <label for="<%= recipe.id %>-checkbox" title="Ingredients: <%= h.call(recipe.all_ingredient_names(alias_map).join(', ')) %>"><%= recipe.title %></label>
            <a href="<%= recipe.id %>" class="recipe-link" title="Open <%= recipe.title %> in new tab" target="_blank">â†’</a>
          </li>
        <%- end -%>
        </ul>
      </div>
      <%- end -%>

      <%- if quick_bites_by_subsection.any? -%>
      <div class="quick-bites">
        <h2>Quick Bites</h2>
        <div class="subsections">
          <%- quick_bites_by_subsection.each do |subsection, items| -%>
          <div class="subsection">
            <h3><%= subsection %></h3>
            <ul>
            <%- items.each do |item| -%>
              <li>
                <input type="checkbox" id="<%= item.id %>-checkbox" data-title="<%= h.call(item.title) %>" data-ingredients="<%= h.call(item.ingredients_with_quantities.to_json) %>">
                <label for="<%= item.id %>-checkbox" title="Ingredients: <%= h.call(item.all_ingredient_names.join(', ')) %>"><%= item.title %></label>
              </li>
            <%- end -%>
            </ul>
          </div>
          <%- end -%>
        </div>
      </div>
      <%- end -%>
    </div>

    <div id="custom-items-section" class="hidden-until-js">
      <h2>Additional Items</h2>
      <div id="custom-input-row">
        <input type="text" id="custom-input" placeholder="Add an item...">
        <button id="custom-add" type="button" aria-label="Add item"><svg viewBox="0 0 24 24" width="18" height="18"><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button>
      </div>
      <ul id="custom-items-list"></ul>
    </div>

    <div id="share-section" class="hidden-until-js">
      <h2>Share</h2>
      <p id="share-hint">Scan the QR code or copy the link below to open this list on another device.</p>
      <div id="qr-container"></div>
      <div id="share-url-row">
        <code id="share-url"></code>
        <button id="share-action" type="button" aria-label="Share or copy link"></button>
      </div>
      <p id="share-feedback" hidden></p>
    </div>

    <div id="grocery-preview" class="hidden-until-js">
      <div id="grocery-preview-header">
        <h2>Shopping List</h2>
        <span class="item-count" id="item-count"></span>
      </div>
      <p id="grocery-preview-empty">Select recipes above to build your shopping list.</p>

      <section id="grocery-list">
      <%- ingredient_database.each do |aisle, ingredients| -%>
      <%- next if aisle == "Omit_From_List" -%>
      <details class="aisle">
        <summary><%= aisle %> <span class="aisle-count"></span></summary>
        <ul>
          <%- ingredients.each do |ingredient| -%>
            <li data-item="<%= h.call(ingredient[:name]) %>" hidden>
              <label class="check-off">
                <input type="checkbox">
                <span><%= ingredient[:name] %><span class="qty"></span></span>
              </label>
            </li>
          <%- end -%>
        </ul>
      </details>
      <%- end -%>

      <details class="aisle" id="misc-aisle">
        <summary>Miscellaneous <span class="aisle-count"></span></summary>
        <ul id="misc-items"></ul>
      </details>
      </section>
    </div>
  </main>

<div id="state-notice" hidden></div>

<script src="qrcodegen.js" defer></script>
<script src="groceries.js" defer></script>

</body>
</html>
