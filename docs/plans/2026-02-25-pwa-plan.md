# PWA Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers-extended-cc:executing-plans to implement this plan task-by-task.

**Goal:** Make the site installable as a PWA with offline support for the grocery shopping flow.

**Architecture:** Runtime-caching service worker (cache-first for fingerprinted assets, network-first for HTML pages). Icons generated at build time from favicon.svg via rsvg-convert. No precache manifest, no build step for the service worker itself.

**Tech Stack:** Service Worker API, Web App Manifest, rsvg-convert (librsvg2-bin), Rake task, Propshaft (existing asset pipeline)

**Design doc:** `docs/plans/2026-02-25-pwa-design.md`

---

### Task 0: Install librsvg2-bin locally

This is a prerequisite for all icon generation work.

**Step 1: Install the package**

Run: `sudo apt-get install -y librsvg2-bin`

**Step 2: Verify**

Run: `rsvg-convert --version`
Expected: Version output (2.58+)

---

### Task 1: Create the icon generation rake task

**Files:**
- Create: `lib/tasks/pwa.rake`

The rake task generates all PWA icons from the single SVG source.

**Step 1: Write the rake task**

```ruby
# frozen_string_literal: true

namespace :pwa do
  desc 'Generate PWA icons from favicon.svg using rsvg-convert'
  task icons: :environment do
    source = Rails.root.join('app/assets/images/favicon.svg')
    output_dir = Rails.root.join('public/icons')

    abort "Source SVG not found: #{source}" unless source.exist?

    FileUtils.mkdir_p(output_dir)

    icons = {
      'icon-192.png' => 192,
      'icon-512.png' => 512,
      'apple-touch-icon.png' => 180,
      'favicon-32.png' => 32
    }

    icons.each do |filename, size|
      output = output_dir.join(filename)
      system('rsvg-convert', '-w', size.to_s, '-h', size.to_s,
             source.to_s, '-o', output.to_s, exception: true)
      puts "  Generated #{filename} (#{size}x#{size})"
    end
  end
end
```

**Step 2: Run the task**

Run: `bundle exec rake pwa:icons`
Expected: Four lines of "Generated ..." output. Files created in `public/icons/`.

**Step 3: Verify the generated files**

Run: `ls -la public/icons/`
Expected: `icon-192.png`, `icon-512.png`, `apple-touch-icon.png`, `favicon-32.png`

Run: `file public/icons/icon-512.png`
Expected: `PNG image data, 512 x 512`

**Step 4: Commit**

```bash
git add lib/tasks/pwa.rake
git commit -m "feat: add rake pwa:icons task to generate PWA icons from SVG"
```

---

### Task 2: Remove binary assets from repo

**Files:**
- Remove: `app/assets/images/apple-touch-icon.png`
- Remove: `app/assets/images/favicon.ico`

**Step 1: Remove tracked binary files**

```bash
git rm app/assets/images/apple-touch-icon.png app/assets/images/favicon.ico
```

**Step 2: Commit**

```bash
git commit -m "chore: remove binary favicon assets (now generated from SVG)"
```

---

### Task 3: Update the layout head tags

**Files:**
- Modify: `app/views/layouts/application.html.erb`

The layout currently references the old binary assets. Update to point at the generated icons and add the service worker registration script.

**Current head (lines 9-14):**

```erb
  <%= stylesheet_link_tag 'style' %>
  <link rel="icon" type="image/svg+xml" href="<%= asset_path('favicon.svg') %>">
  <link rel="shortcut icon" href="<%= asset_path('favicon.ico') %>">
  <link rel="apple-touch-icon" sizes="180x180" href="<%= asset_path('apple-touch-icon.png') %>">
  <link rel="manifest" href="/manifest.json">
  <%= yield :head %>
```

**Replace with:**

```erb
  <%= stylesheet_link_tag 'style' %>
  <link rel="icon" type="image/svg+xml" href="<%= asset_path('favicon.svg') %>">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <link rel="manifest" href="/manifest.json">
  <%= javascript_include_tag 'sw-register', defer: true %>
  <%= yield :head %>
```

Changes:
- Replace `shortcut icon` (favicon.ico) with PNG favicon fallback at `/icons/favicon-32.png`
- Replace apple-touch-icon Propshaft path with static `/icons/apple-touch-icon.png`
- Add `sw-register.js` (created in Task 5)

**Step 1: Make the edit**

Edit `app/views/layouts/application.html.erb` — replace the three icon link tags and add the script tag.

**Step 2: Verify the server still starts**

Run: `bin/dev` and visit `http://localhost:3030`
Expected: Page loads. Check the `<head>` in devtools — new icon paths present, `sw-register.js` loads (will 404 until Task 5, that's fine).

**Step 3: Commit**

```bash
git add app/views/layouts/application.html.erb
git commit -m "feat: update layout for PWA icons and service worker registration"
```

---

### Task 4: Update the manifest

**Files:**
- Modify: `public/manifest.json`

**Current content:**

```json
{
  "name": "Family Recipes",
  "short_name": "Recipes",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#cd4754",
  "icons": []
}
```

**Replace with:**

```json
{
  "name": "Family Recipes",
  "short_name": "Recipes",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#cd4754",
  "icons": [
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ],
  "shortcuts": [
    {
      "name": "Grocery List",
      "short_name": "Groceries",
      "url": "/groceries"
    }
  ]
}
```

**Step 1: Write the updated manifest**

**Step 2: Validate**

Run the dev server, open Chrome DevTools > Application > Manifest. Verify:
- Icons load (no 404s — requires Task 1 to have run `rake pwa:icons`)
- Shortcut entry appears
- No manifest warnings

**Step 3: Commit**

```bash
git add public/manifest.json
git commit -m "feat: add PWA icons and grocery shortcut to manifest"
```

---

### Task 5: Create the service worker registration script

**Files:**
- Create: `app/assets/javascripts/sw-register.js`

This is a tiny script that registers the service worker. It's an external file because the CSP forbids inline scripts.

**Step 1: Write the registration script**

```javascript
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js');
}
```

That's it. No error handling needed — if registration fails (e.g., localhost without HTTPS), the site works fine without it. Service workers require HTTPS in production, but browsers make an exception for `localhost`.

**Step 2: Verify the script is served by Propshaft**

Run: `curl -s http://localhost:3030/assets/sw-register.js | head -5`
Expected: The script contents (Propshaft serves from `app/assets/javascripts/`)

**Step 3: Commit**

```bash
git add app/assets/javascripts/sw-register.js
git commit -m "feat: add service worker registration script"
```

---

### Task 6: Create the service worker

**Files:**
- Create: `public/service-worker.js`

This is the core of the PWA. It must live in `public/` (not `app/assets/`) so it's served at the root URL `/service-worker.js` — the service worker's scope is determined by its URL path.

**Step 1: Write the service worker**

```javascript
var CACHE_NAME = 'familyrecipes-v1';
var OFFLINE_URL = '/offline.html';

// Install: cache the offline fallback
self.addEventListener('install', function(event) {
  event.waitUntil(
    caches.open(CACHE_NAME).then(function(cache) {
      return cache.add(OFFLINE_URL);
    })
  );
  self.skipWaiting();
});

// Activate: clean up old caches, claim clients
self.addEventListener('activate', function(event) {
  event.waitUntil(
    caches.keys().then(function(keys) {
      return Promise.all(
        keys.filter(function(k) { return k !== CACHE_NAME; })
            .map(function(k) { return caches.delete(k); })
      );
    }).then(function() {
      return self.clients.claim();
    })
  );
});

// Fetch: route by strategy
self.addEventListener('fetch', function(event) {
  var request = event.request;
  if (request.method !== 'GET') return;

  var url = new URL(request.url);

  // Skip WebSocket and API endpoints — groceries JS manages its own caching
  if (url.pathname === '/cable') return;
  if (url.pathname.match(/^\/(kitchens\/[^/]+\/)?(groceries\/(state|select|check|custom_items|clear|quick_bites|aisle_order))/)) return;
  if (url.pathname.match(/^\/nutrition\//)) return;

  // Fingerprinted assets: cache-first (immutable)
  if (url.pathname.startsWith('/assets/')) {
    event.respondWith(cacheFirst(request));
    return;
  }

  // Static icons and manifest: cache-first
  if (url.pathname.startsWith('/icons/') || url.pathname === '/manifest.json') {
    event.respondWith(cacheFirst(request));
    return;
  }

  // HTML pages: network-first with cache fallback
  if (request.headers.get('accept') && request.headers.get('accept').includes('text/html')) {
    event.respondWith(networkFirstHTML(request));
    return;
  }

  // Everything else: cache-first
  event.respondWith(cacheFirst(request));
});

function cacheFirst(request) {
  return caches.match(request).then(function(cached) {
    if (cached) return cached;
    return fetch(request).then(function(response) {
      if (response.ok) {
        var clone = response.clone();
        caches.open(CACHE_NAME).then(function(cache) { cache.put(request, clone); });
      }
      return response;
    });
  });
}

function networkFirstHTML(request) {
  return fetch(request).then(function(response) {
    if (response.ok) {
      var clone = response.clone();
      caches.open(CACHE_NAME).then(function(cache) { cache.put(request, clone); });
    }
    return response;
  }).catch(function() {
    return caches.match(request).then(function(cached) {
      return cached || caches.match(OFFLINE_URL);
    });
  });
}
```

Design notes for the implementer:
- Uses `var` and `function` syntax (not `const`/arrow functions) to match the project's existing JS style in `groceries.js` and `wake-lock.js`.
- The API endpoint regex accounts for both root (`/groceries/state`) and kitchen-scoped (`/kitchens/slug/groceries/state`) URLs.
- Only caches `response.ok` (200-299) — never caches error pages.
- `networkFirstHTML` falls back to cache, then to the offline page as last resort.

**Step 2: Verify the SW is served at the right URL**

Run: `curl -s http://localhost:3030/service-worker.js | head -3`
Expected: First three lines of the service worker.

**Step 3: Commit**

```bash
git add public/service-worker.js
git commit -m "feat: add service worker with runtime caching"
```

---

### Task 7: Create the offline fallback page

**Files:**
- Create: `public/offline.html`

Follows the same pattern as `public/404.html` — a self-contained error page. Uses `public/error.css` for base styling (shared with 404) and adds the emoji via CSS `::after` pseudo-element, same as the 404 page uses for the woozy face.

**Step 1: Check the existing error page pattern**

The 404 page (`public/404.html`) uses `/error.css` which centers text and adds an emoji via `h1::after`. We'll update `error.css` to support both pages — the 404 uses the woozy face, the offline page uses the desert island.

**Step 2: Update error.css to support page-specific emoji**

Current `public/error.css`:

```css
body {
  text-align: center;
}

h1::after {
  content: "\1F974";
  display: block;
  margin: 1rem;
}
```

Replace with:

```css
body {
  text-align: center;
}

h1::after {
  display: block;
  margin: 1rem;
}

.error-404 h1::after {
  content: "\1F974";
}

.error-offline h1::after {
  content: "\1F3DD\FE0F";
}
```

**Step 3: Update 404.html to add the body class**

In `public/404.html`, change `<body>` to `<body class="error-404">`.

**Step 4: Write the offline page**

```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Offline</title>
    <link rel="stylesheet" href="/error.css">
  </head>
  <body class="error-offline">
    <h1>You're offline</h1>
    <p>Check your connection and try again.</p>
    <p><a href="/">Back to the homepage</a></p>
  </body>
</html>
```

**Step 5: Verify both pages render**

- Visit `http://localhost:3030/offline.html` — should show desert island emoji
- Visit `http://localhost:3030/404.html` — should still show woozy face emoji (not broken by CSS change)

**Step 6: Commit**

```bash
git add public/offline.html public/error.css public/404.html
git commit -m "feat: add offline fallback page with desert island emoji"
```

---

### Task 8: Update Dockerfile

**Files:**
- Modify: `Dockerfile`

Two changes: add `librsvg2-bin` to the builder stage, and run `rake pwa:icons` after asset precompilation.

**Step 1: Add librsvg2-bin to builder apt-get**

In the builder stage (line 4), add `librsvg2-bin` to the package list:

```dockerfile
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y build-essential libsqlite3-dev libyaml-dev librsvg2-bin && \
    rm -rf /var/lib/apt/lists/*
```

**Step 2: Add rake pwa:icons after assets:precompile**

After line 19 (`RUN SECRET_KEY_BASE=placeholder bin/rails assets:precompile`), add:

```dockerfile
RUN bin/rails pwa:icons
```

**Step 3: Verify Docker build**

Run: `docker build -t familyrecipes:pwa-test .`
Expected: Build succeeds. The `pwa:icons` step prints the four "Generated ..." lines.

**Step 4: Verify the image serves icons**

Run: `docker run --rm -p 3030:3030 familyrecipes:pwa-test`
Then: `curl -sI http://localhost:3030/icons/icon-192.png | head -5`
Expected: HTTP 200 with `Content-Type: image/png`

**Step 5: Commit**

```bash
git add Dockerfile
git commit -m "feat: generate PWA icons during Docker build"
```

---

### Task 9: Update bin/setup and CI

**Files:**
- Modify: `bin/setup`
- Modify: `.github/workflows/test.yml`

**Step 1: Add icon generation to bin/setup**

After the "Installing dependencies" block (line 18) and before the "Removing old logs" block (line 20), add:

```ruby
  puts "\n== Generating PWA icons =="
  system 'bundle exec rake pwa:icons'
```

Note: `system` (not `system!`) — icon generation is nice-to-have in dev. If `rsvg-convert` isn't installed, dev still works (just no PWA icons). Print a helpful message if it fails.

Actually, better approach — make it graceful:

```ruby
  puts "\n== Generating PWA icons =="
  unless system('bundle exec rake pwa:icons')
    puts '   (skipped — install librsvg2-bin for PWA icon generation)'
  end
```

**Step 2: Add librsvg2-bin to CI**

In `.github/workflows/test.yml`, add an apt install step after "Set up Ruby" and before "Set up database":

```yaml
      - name: Install system dependencies
        run: sudo apt-get update -qq && sudo apt-get install -y librsvg2-bin
```

**Step 3: Commit**

```bash
git add bin/setup .github/workflows/test.yml
git commit -m "feat: add PWA icon generation to dev setup and CI"
```

---

### Task 10: Integration test — full PWA verification

This is a manual verification task using browser devtools and Playwright.

**Step 1: Run the full setup**

```bash
bundle exec rake pwa:icons
bin/dev
```

**Step 2: Chrome DevTools verification**

Open `http://localhost:3030` in Chrome. Open DevTools > Application tab.

Check Manifest:
- Name: "Family Recipes"
- Icons: both 192 and 512 load without errors
- Shortcut: "Grocery List" appears
- Installability: no warnings

Check Service Workers:
- Service worker registered and active
- Status: "activated and is running"

Check Cache Storage:
- `familyrecipes-v1` cache exists
- Contains `offline.html`

**Step 3: Test caching behavior**

- Navigate to a recipe page, then to the groceries page
- In DevTools > Network, check "Offline"
- Reload the groceries page — should load from cache
- Navigate to the recipe page — should load from cache
- Navigate to a page you haven't visited — should show the offline page with desert island emoji

**Step 4: Test the grocery flow offline**

- While still offline, check off a grocery item
- Verify the UI updates (localStorage-backed)
- Uncheck "Offline" in DevTools
- Verify the pending action syncs (check the Network tab for the PATCH request)

**Step 5: Commit any fixes found during testing**

---

### Task 11: Final cleanup commit

Squash any fixup commits if needed. Verify:

```bash
bundle exec rake          # lint + test pass
bundle exec rake pwa:icons  # icons generate
```

Run: `git log --oneline` to review the commit history.
